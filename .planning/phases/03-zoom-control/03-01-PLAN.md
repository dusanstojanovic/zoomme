---
phase: 03-zoom-control
plan: 01
type: execute
wave: 1
depends_on: ["02-02"]
files_modified:
  - background.js
autonomous: true

must_haves:
  truths:
    - "Moving closer causes active tab to zoom out (zoom < 1.0)"
    - "Moving to normal distance returns tab to 100% zoom (dead zone)"
    - "Holding still produces stable zoom with no flickering (EMA + dead zone + delta threshold)"
    - "Disabling toggle resets active tab to 100% zoom"
    - "Zoom is per-tab (does not bleed to same-origin tabs)"
  artifacts:
    - path: "background.js"
      provides: "EMA smoothing, dead zone, ratio-to-zoom mapping, setZoom calls, resetZoom on disable"
      contains: "applyZoom"
---

<objective>
Add zoom control to background.js: EMA smoothing, dead zone, ratio-to-zoom mapping, chrome.tabs.setZoom() on active tab, reset on disable.

Purpose: Convert DISTANCE_READING ratio into actual browser zoom on the active tab with stable, jitter-free behavior.
Output: Active tab zooms out when user leans closer, returns to 100% at normal distance, no flickering when still.
</objective>

<context>
@.planning/phases/03-zoom-control/03-RESEARCH.md
@background.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add zoom control logic to background.js</name>
  <files>background.js</files>
  <action>
    Add to background.js:

    1. Zoom constants at top of file:
       - EMA_ALPHA = 0.3
       - DEAD_ZONE_LOW = 0.85, DEAD_ZONE_HIGH = 1.15
       - ZOOM_MIN = 0.5, ZOOM_MAX = 1.5
       - ZOOM_DELTA_MIN = 0.01

    2. Zoom state variables:
       - emaRatio = null, lastZoom = null, activeTabId = null

    3. Active tab tracking:
       - Seed activeTabId on startup via chrome.tabs.query
       - chrome.tabs.onActivated listener to update activeTabId and reset EMA

    4. Functions: updateEma(raw), ratioToZoom(r), applyZoom(rawRatio), resetZoom()

    5. Replace DISTANCE_READING console.log handler with applyZoom(msg.ratio)

    6. Call resetZoom() in disableCamera() before setting storage state
  </action>
  <verify>
    Read background.js — confirm applyZoom, resetZoom, EMA, dead zone, setZoom, per-tab scope, activeTabId tracking all present.
  </verify>
  <done>background.js converts distance readings to zoom levels with EMA smoothing, dead zone, and per-tab scope.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify zoom control end-to-end</name>
  <action>
    1. Reload extension at chrome://extensions
    2. Open any website (e.g., wikipedia.org)
    3. Enable ZoomMe via popup
    4. Sit at normal distance — page should stay at 100%
    5. Lean closer to screen — page should zoom OUT (more content visible)
    6. Return to normal — page returns to ~100%
    7. Lean back/farther — page should zoom IN slightly
    8. Hold still — zoom should be stable, no flickering
    9. Disable toggle — page resets to 100% immediately
    10. Switch tabs while enabled — zoom should work on new tab too
  </action>
  <verify>Human confirms all 10 steps pass.</verify>
  <done>Zoom control verified: distance-responsive, stable, resets on disable.</done>
</task>

</tasks>

<success_criteria>
Active tab zoom responds to head distance with EMA smoothing and dead zone. No flickering when still. Resets to 100% on disable.
</success_criteria>
