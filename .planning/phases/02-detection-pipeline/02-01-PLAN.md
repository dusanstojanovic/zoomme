---
phase: 02-detection-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - vendor/vision_bundle.mjs
  - wasm/vision_wasm_internal.js
  - wasm/vision_wasm_internal.wasm
  - wasm/vision_wasm_nosimd_internal.js
  - wasm/vision_wasm_nosimd_internal.wasm
  - model/face_landmarker.task
autonomous: true

must_haves:
  truths:
    - "MediaPipe WASM files exist in wasm/ directory (SIMD + noSIMD variants)"
    - "FaceLandmarker model file exists at model/face_landmarker.task"
    - "vision_bundle.mjs exists at vendor/vision_bundle.mjs"
    - "manifest.json CSP includes wasm-unsafe-eval and web_accessible_resources covers wasm/*, model/*, vendor/*"
  artifacts:
    - path: "wasm/vision_wasm_internal.js"
      provides: "WASM SIMD loader"
    - path: "wasm/vision_wasm_internal.wasm"
      provides: "WASM SIMD binary"
    - path: "wasm/vision_wasm_nosimd_internal.js"
      provides: "WASM noSIMD loader"
    - path: "wasm/vision_wasm_nosimd_internal.wasm"
      provides: "WASM noSIMD binary"
    - path: "model/face_landmarker.task"
      provides: "FaceLandmarker model weights"
    - path: "vendor/vision_bundle.mjs"
      provides: "MediaPipe Tasks Vision ES module"
    - path: "manifest.json"
      provides: "CSP + web_accessible_resources for WASM loading"
      contains: "wasm-unsafe-eval"
  key_links:
    - from: "manifest.json"
      to: "wasm/*"
      via: "web_accessible_resources declaration"
      pattern: "wasm/\\*"
---

<objective>
Bundle MediaPipe Tasks Vision assets locally and configure manifest.json for WASM execution.

Purpose: Phase 2 detection code needs locally-bundled WASM, model, and JS module files because Chrome extension CSP blocks CDN fetches. Manifest must allow WASM execution and declare resources as web-accessible.
Output: wasm/, model/, vendor/ directories with all MediaPipe assets; updated manifest.json with CSP and web_accessible_resources.
</objective>

<execution_context>
@/Users/dusan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dusan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-detection-pipeline/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract MediaPipe WASM + model + bundle into extension</name>
  <files>
    vendor/vision_bundle.mjs
    wasm/vision_wasm_internal.js
    wasm/vision_wasm_internal.wasm
    wasm/vision_wasm_nosimd_internal.js
    wasm/vision_wasm_nosimd_internal.wasm
    model/face_landmarker.task
  </files>
  <action>
    1. From project root, run: `npm pack @mediapipe/tasks-vision@0.10.32`
    2. Extract the tarball: `tar xzf mediapipe-tasks-vision-0.10.32.tgz`
    3. Create directories: `mkdir -p wasm model vendor`
    4. Copy WASM files from the extracted package:
       - `cp package/wasm/vision_wasm_internal.js wasm/`
       - `cp package/wasm/vision_wasm_internal.wasm wasm/`
       - `cp package/wasm/vision_wasm_nosimd_internal.js wasm/`
       - `cp package/wasm/vision_wasm_nosimd_internal.wasm wasm/`
    5. Copy the ES module bundle: `cp package/vision_bundle.mjs vendor/vision_bundle.mjs`
    6. Download the FaceLandmarker model:
       `curl -L -o model/face_landmarker.task "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task"`
    7. Clean up: `rm -rf package mediapipe-tasks-vision-0.10.32.tgz`
    8. Verify files exist and have reasonable sizes (WASM binaries ~10-11MB each, model ~3.6MB, vision_bundle.mjs ~200KB+).

    NOTE: These are large binary files. Add wasm/, model/, vendor/ to .gitignore if not already there â€” OR commit them (they're required for the extension to run). Decision: commit them since the extension has no build step and these files must ship with it.
  </action>
  <verify>
    Run: `ls -lh wasm/ model/ vendor/vision_bundle.mjs`
    Expect: 4 WASM files in wasm/, face_landmarker.task in model/, vision_bundle.mjs in vendor/.
    WASM binaries should be ~10-11MB each, model ~3.6MB.
  </verify>
  <done>All 6 MediaPipe asset files exist with correct sizes in their respective directories.</done>
</task>

<task type="auto">
  <name>Task 2: Update manifest.json with CSP and web_accessible_resources</name>
  <files>manifest.json</files>
  <action>
    Edit manifest.json to add two new top-level keys:

    1. `content_security_policy`:
       ```json
       "content_security_policy": {
         "extension_pages": "script-src 'self' 'wasm-unsafe-eval'; object-src 'self';"
       }
       ```

    2. `web_accessible_resources`:
       ```json
       "web_accessible_resources": [
         {
           "resources": ["wasm/*", "model/*", "vendor/*"],
           "matches": ["<all_urls>"]
         }
       ]
       ```

    Keep all existing keys unchanged. These additions enable:
    - WASM compilation in extension pages (offscreen document)
    - Fetch access to WASM binaries, model file, and JS bundle from extension pages

    Do NOT change any existing permissions, background, action, or icon entries.
  </action>
  <verify>
    Read manifest.json and confirm:
    1. `content_security_policy.extension_pages` contains `wasm-unsafe-eval`
    2. `web_accessible_resources[0].resources` includes `wasm/*`, `model/*`, `vendor/*`
    3. All pre-existing keys (manifest_version, name, version, etc.) are intact
  </verify>
  <done>manifest.json has CSP allowing WASM execution and web_accessible_resources covering all MediaPipe asset directories.</done>
</task>

</tasks>

<verification>
1. `ls wasm/` shows 4 files (2 .js + 2 .wasm)
2. `ls model/` shows face_landmarker.task
3. `ls vendor/` shows vision_bundle.mjs
4. `cat manifest.json | grep wasm-unsafe-eval` returns a match
5. `cat manifest.json | grep "wasm/\*"` returns a match
</verification>

<success_criteria>
All MediaPipe assets are bundled locally and manifest.json is configured for WASM execution. The extension can be loaded in Chrome without CSP errors when WASM code attempts to compile.
</success_criteria>

<output>
After completion, create `.planning/phases/02-detection-pipeline/02-01-SUMMARY.md`
</output>
