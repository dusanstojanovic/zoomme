---
phase: 04-ui-persistence
plan: 01
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - background.js
  - popup/popup.html
  - popup/popup.css
  - popup/popup.js
autonomous: false
requirements:
  - ZOOM-05
  - EXCL-01
  - EXCL-02
  - EXCL-03
  - SET-01
  - SET-02

must_haves:
  truths:
    - "Dragging the slider immediately updates the zoom level on the active tab"
    - "Slider position is restored correctly when the popup is reopened"
    - "Clicking Exclude adds the current hostname to the excluded list and zoom stops applying on that site"
    - "Individual sites can be removed from the excluded list via a Remove button"
    - "Excluded sites list and slider value survive browser restart"
    - "Exclude button is disabled on non-http tabs (e.g. chrome:// pages)"
  artifacts:
    - path: "background.js"
      provides: "Settings cache, onChanged listener, exclusion check, dynamic zoomMax"
      contains: "settings.excludedSites"
    - path: "popup/popup.html"
      provides: "Slider row, exclude button, excluded list container"
      contains: "zoom-slider"
    - path: "popup/popup.js"
      provides: "initSettings, slider handlers, exclude button handler, renderExcludedList"
      contains: "renderExcludedList"
  key_links:
    - from: "popup/popup.js"
      to: "chrome.storage.sync"
      via: "chrome.storage.sync.set / .get"
      pattern: "storage\\.sync\\.(set|get)"
    - from: "background.js"
      to: "settings.zoomMax"
      via: "ratioToZoom second parameter"
      pattern: "ratioToZoom\\(.*settings\\.zoomMax"
    - from: "background.js"
      to: "settings.excludedSites"
      via: "Array.includes check in applyZoom"
      pattern: "excludedSites\\.includes"
---

<objective>
Add max-zoom slider, per-site exclusion toggle, and chrome.storage.sync persistence to ZoomMe.

Purpose: Users need control over how aggressively zoom applies and a way to opt specific sites out. Both settings must survive browser restarts.
Output: Working slider in popup, working exclude/remove UI, background enforcing both settings via in-memory cache kept fresh by storage.onChanged.
</objective>

<context>
@.planning/phases/04-ui-persistence/04-RESEARCH.md
@popup/popup.html
@popup/popup.js
@popup/popup.css
@background.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: background.js — settings cache, onChanged listener, dynamic zoomMax, exclusion check</name>
  <files>background.js</files>
  <action>
Make the following changes to background.js in order:

1. Replace the two constants at the top:
   ```
   const ZOOM_MIN = 0.3;
   const ZOOM_MAX = 2.5;
   ```
   with:
   ```
   const ZOOM_MIN = 0.3; // not user-configurable

   let settings = { zoomMax: 2.5, excludedSites: [] };

   chrome.storage.sync.get({ zoomMax: 2.5, excludedSites: [] }, (stored) => {
     settings = stored;
   });

   chrome.storage.onChanged.addListener((changes, area) => {
     if (area !== 'sync') return;
     if (changes.zoomMax)        settings.zoomMax        = changes.zoomMax.newValue;
     if (changes.excludedSites)  settings.excludedSites  = changes.excludedSites.newValue;
   });
   ```

2. Change `ratioToZoom` signature from `function ratioToZoom(r)` to `function ratioToZoom(r, zoomMax)` and replace the two references to the removed `ZOOM_MAX` constant inside the function body with the `zoomMax` parameter. The function uses `ZOOM_MAX` in one place: `return 1.0 + t * (ZOOM_MAX - 1.0)` — change to `return 1.0 + t * (zoomMax - 1.0)`. The `ZOOM_MIN` constant in the body stays as-is (it references the still-present `const ZOOM_MIN`).

3. In `applyZoom`, add an exclusion check immediately after the `activeTabId` resolution block (after the `if (!tab) return; activeTabId = tab.id;` block) and before the zoom calculation. Insert:
   ```javascript
   try {
     const tab = await chrome.tabs.get(activeTabId);
     if (tab.url) {
       const hostname = new URL(tab.url).hostname;
       if (settings.excludedSites.includes(hostname)) return;
     }
   } catch (e) {
     return; // tab closed or restricted
   }
   ```

4. Change the zoom calculation line from:
   ```javascript
   const zoom = ratioToZoom(updateEma(rawRatio));
   ```
   to:
   ```javascript
   const zoom = ratioToZoom(updateEma(rawRatio), settings.zoomMax);
   ```
  </action>
  <verify>
    Read background.js and confirm:
    - `settings` object declared with `zoomMax: 2.5, excludedSites: []`
    - `chrome.storage.sync.get(...)` call present at top level (not inside a function)
    - `chrome.storage.onChanged.addListener(...)` present at top level
    - `ratioToZoom` signature is `function ratioToZoom(r, zoomMax)`
    - `ZOOM_MAX` constant is gone (no remaining references)
    - `settings.excludedSites.includes(hostname)` present in applyZoom
    - `ratioToZoom(updateEma(rawRatio), settings.zoomMax)` in applyZoom
  </verify>
  <done>background.js uses dynamic settings cache; zoom respects excluded sites and user-configured zoomMax</done>
</task>

<task type="auto">
  <name>Task 2: popup.html + popup.css — add slider row, exclude button, excluded list</name>
  <files>popup/popup.html, popup/popup.css</files>
  <action>
**popup.html:** Inside the `<div class="popup">` element, after the `<div id="indicator" ...>` line and before `</div>`, add:
```html
    <div class="slider-row">
      <span>Max zoom</span>
      <input id="zoom-slider" type="range" min="1.2" max="3.0" step="0.1" value="2.5">
      <span id="zoom-label">2.5x</span>
    </div>
    <button id="exclude-btn" disabled>Exclude this site</button>
    <div id="excluded-list"></div>
```

**popup.css:** Append to the end of the file:
```css
.slider-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
}

.slider-row input[type="range"] {
  flex: 1;
}

#exclude-btn {
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background: #fff;
  cursor: pointer;
  font-size: 13px;
}

#exclude-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.excluded-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 13px;
}

.excluded-row button {
  padding: 2px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  font-size: 12px;
}

#excluded-list {
  margin-top: 4px;
  color: #444;
  font-size: 13px;
}
```
  </action>
  <verify>
    Read popup/popup.html — confirm `zoom-slider`, `zoom-label`, `exclude-btn`, `excluded-list` elements present.
    Read popup/popup.css — confirm `.slider-row`, `#exclude-btn`, `.excluded-row`, `#excluded-list` rules present.
  </verify>
  <done>popup.html contains all required UI elements; popup.css contains all required style rules</done>
</task>

<task type="auto">
  <name>Task 3: popup.js — initSettings, slider handlers, exclude button, renderExcludedList</name>
  <files>popup/popup.js</files>
  <action>
Append the following block to the end of popup.js (after the existing `document.addEventListener('DOMContentLoaded', refreshState);` line):

```javascript

// --- Settings (zoom slider + site exclusion) ---

function renderExcludedList(sites) {
  const list = document.getElementById('excluded-list');
  list.innerHTML = '';
  if (sites.length === 0) {
    list.textContent = 'No excluded sites.';
    return;
  }
  sites.forEach(hostname => {
    const row = document.createElement('div');
    row.className = 'excluded-row';
    const label = document.createElement('span');
    label.textContent = hostname;
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', () => removeSite(hostname));
    row.appendChild(label);
    row.appendChild(removeBtn);
    list.appendChild(row);
  });
}

async function removeSite(hostname) {
  const { excludedSites } = await chrome.storage.sync.get({ excludedSites: [] });
  const updated = excludedSites.filter(h => h !== hostname);
  await chrome.storage.sync.set({ excludedSites: updated });
  renderExcludedList(updated);
}

async function initSettings() {
  const slider = document.getElementById('zoom-slider');
  const label  = document.getElementById('zoom-label');
  const excludeBtn = document.getElementById('exclude-btn');

  // Load persisted settings
  const { zoomMax, excludedSites } = await chrome.storage.sync.get({
    zoomMax: 2.5,
    excludedSites: []
  });
  slider.value = zoomMax;
  label.textContent = `${parseFloat(zoomMax).toFixed(1)}x`;
  renderExcludedList(excludedSites);

  // Slider: update label live, write to storage on release
  slider.addEventListener('input', () => {
    label.textContent = `${parseFloat(slider.value).toFixed(1)}x`;
  });
  slider.addEventListener('change', async () => {
    await chrome.storage.sync.set({ zoomMax: parseFloat(slider.value) });
  });

  // Exclude button: get active tab hostname, toggle inclusion in excludedSites
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  if (tab?.url?.startsWith('http')) {
    const hostname = new URL(tab.url).hostname;
    const isExcluded = excludedSites.includes(hostname);
    excludeBtn.textContent = isExcluded ? `Remove exclusion for ${hostname}` : `Exclude ${hostname}`;
    excludeBtn.disabled = false;

    excludeBtn.addEventListener('click', async () => {
      const { excludedSites: current } = await chrome.storage.sync.get({ excludedSites: [] });
      let updated;
      if (current.includes(hostname)) {
        updated = current.filter(h => h !== hostname);
        excludeBtn.textContent = `Exclude ${hostname}`;
      } else {
        updated = [...current, hostname];
        excludeBtn.textContent = `Remove exclusion for ${hostname}`;
      }
      await chrome.storage.sync.set({ excludedSites: updated });
      renderExcludedList(updated);
    });
  }
  // else: excludeBtn remains disabled (non-http tab, already set in HTML)
}

// Replace the single-line DOMContentLoaded listener above with a combined one
document.addEventListener('DOMContentLoaded', () => {
  refreshState();
  initSettings();
});
```

**Important:** The file already ends with `document.addEventListener('DOMContentLoaded', refreshState);`. After appending the block above, that line will be superseded by the new combined listener at the bottom of the appended block. Remove the old single-line listener to avoid calling `refreshState` twice. The final file should have exactly one `DOMContentLoaded` listener — the combined one that calls both `refreshState()` and `initSettings()`.
  </action>
  <verify>
    Read popup/popup.js and confirm:
    - `renderExcludedList` function present
    - `removeSite` function present
    - `initSettings` async function present
    - `chrome.storage.sync.get` called inside `initSettings` with defaults `{ zoomMax: 2.5, excludedSites: [] }`
    - `slider.addEventListener('input', ...)` and `slider.addEventListener('change', ...)` both present
    - Exclude button handler toggles between "Exclude {hostname}" and "Remove exclusion for {hostname}"
    - Exactly one `DOMContentLoaded` listener that calls both `refreshState()` and `initSettings()`
  </verify>
  <done>popup.js loads settings on open, persists slider on release, toggles site exclusion, and renders the excluded list with remove buttons</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Human verification — slider, exclusion, persistence</name>
  <action>
Load the extension (chrome://extensions → Load unpacked → select the zoomme directory, or click the reload button if already loaded).

Test each scenario:

1. **Slider changes zoom behavior:**
   - Open popup. Drag slider left toward 1.2x. Move your face closer to the camera. Zoom-in effect should now reach a lower maximum.
   - Drag slider right toward 3.0x. Move face away (further). Zoom-in should reach a higher maximum.

2. **Slider persists:**
   - Set slider to 1.8x. Close the popup. Reopen the popup. Slider must show 1.8x (not 2.5x).

3. **Exclude button on http tab:**
   - Navigate to any https:// site (e.g. github.com). Open popup.
   - Button should read "Exclude github.com" and be enabled.
   - Click it. Button should change to "Remove exclusion for github.com". Site should appear in the excluded list below the button.
   - Enable ZoomMe (toggle on). Move your face — zoom should NOT change on github.com.

4. **Remove exclusion:**
   - With github.com in the excluded list, click its "Remove" button. It disappears from the list. Button text reverts to "Exclude github.com". ZoomMe resumes zooming on that tab.

5. **Persistence across browser restart:**
   - Add a site to the excluded list and set a non-default slider value (e.g. 1.5x).
   - Quit Chrome completely (File → Quit, or Cmd+Q on Mac).
   - Reopen Chrome and the extension popup.
   - Slider must show 1.5x. Excluded site must still be in the list.

6. **Non-http tab:**
   - Navigate to chrome://extensions. Open popup.
   - "Exclude this site" button must be disabled (grayed out).
  </action>
  <verify>Human confirms all six test scenarios pass.</verify>
  <done>All Phase 4 success criteria verified by human tester: slider affects zoom, slider persists, exclude/remove works, zoom skips excluded sites, settings survive browser restart, button disabled on chrome:// tabs</done>
</task>

</tasks>

<success_criteria>
- Dragging the slider changes the maximum zoom factor applied to the active tab
- Slider value is saved to chrome.storage.sync on release and restored on popup open
- Clicking "Exclude {hostname}" adds the hostname to excludedSites in chrome.storage.sync; background skips zoom on that tab
- Clicking "Remove exclusion for {hostname}" or the Remove button in the list removes it from storage
- Excluded sites list renders with one Remove button per site; "No excluded sites." shown when empty
- Exclude button disabled on non-http tabs
- slider value and excludedSites both survive full browser quit-and-restart
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-persistence/04-01-SUMMARY.md` following the summary template at `.planning/templates/summary.md` (or `.claude/get-shit-done/templates/summary.md`).
</output>
```
